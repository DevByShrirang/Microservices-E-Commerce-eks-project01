@Library('jenkins-shared-library') _

pipeline {
    agent any
    environment {
        ACCOUNT_ID = "442042505508"
        REGION = "us-east-2"
        GIT_EMAIL = "shrirang.patil1812@gmail.com"
        GIT_USER_NAME = "DevByShrirang"
        GIT_REPO_NAME = "Microservices-E-Commerce-eks-project01"
        IMAGE_TAG = "${env.BUILD_NUMBER}" // dynamic tag per build
    }

    stages {
        stage('Clean Workspace') {
            steps { cleanWs() }
        }

        stage('Checkout') {
            steps {
                git branch: 'master', url: "https://github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git"
            }
        }

        stage('Build & Deploy All Services') {
            steps {
                script {
                    def services = ["adservice","checkoutservice","currencyservice","emailservice",
                                    "frontend","loadgenerator","paymentservice","productcatalogservice",
                                    "recommendationservice","shippingservice"] // cartservice skipped

                    for (s in services) {
                        echo "Processing service: ${s}"
                        try {
                            // Build & push Docker image
                            buildAndPush(SERVICE_NAME: s, ACCOUNT_ID: env.ACCOUNT_ID, REGION: env.REGION, TAG: env.IMAGE_TAG)

                            // Find all YAML files for this service
                            def yamlFiles = sh(
                                script: "ls kubernetes-files/${s}/*.yaml 2>/dev/null || echo ''",
                                returnStdout: true
                            ).trim()

                            if (yamlFiles) {
                                yamlFiles.split("\n").each { file ->
                                    echo "Updating manifest for file: ${file}"

                                    // Update image tag in YAML file dynamically
                                    sh """
                                        sed -i 's|image:.*|image: ${env.ACCOUNT_ID}.dkr.ecr.${env.REGION}.amazonaws.com/${s}:${env.IMAGE_TAG}|' ${file}
                                    """

                                    // Optional: commit updated YAML back to Git
                                    sh """
                                        git config user.email "${env.GIT_EMAIL}"
                                        git config user.name "${env.GIT_USER_NAME}"
                                        git add ${file}
                                        git commit -m "Updated image tag for ${s} to ${env.IMAGE_TAG}" || echo "No changes to commit"
                                        git push origin master || echo "Push failed"
                                    """
                                }
                            } else {
                                echo "No YAML found for service: ${s}, skipping manifest update."
                            }

                        } catch (err) {
                            echo "Service ${s} failed, skipping to next. Error: ${err}"
                        }
                    }
                }
            }
        }
    }
}
