@Library('jenkins-shared-library') _

pipeline {
    agent any
    environment {
        ACCOUNT_ID = "442042505508"
        REGION = "us-east-2"
        GIT_EMAIL = "shrirang.patil1812@gmail.com"
        GIT_USER_NAME = "DevByShrirang"
        GIT_REPO_NAME = "Microservices-E-Commerce-eks-project01"
        // Default service (can be overridden per build)
        SERVICE_NAME = "adservice"
    }

    stages {
        stage('Clean Workspace') {
            steps { cleanWs() }
        }

        stage('Checkout') {
            steps {
                git branch: 'master', url: "https://github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git"
            }
        }

        stage('Build & Push Docker') {
            steps {
                buildAndPush(
                    SERVICE_NAME: env.SERVICE_NAME,
                    ACCOUNT_ID: env.ACCOUNT_ID,
                    REGION: env.REGION
                )
            }
        }

        stage('Update Manifest') {
            steps {
                updateManifest(
                    SERVICE_NAME: env.SERVICE_NAME,
                    ACCOUNT_ID: env.ACCOUNT_ID,
                    REPO_URL: "${env.ACCOUNT_ID}.dkr.ecr.${env.REGION}.amazonaws.com/${env.SERVICE_NAME}",
                    YAML_FILE: "${env.SERVICE_NAME}.yaml",
                    GIT_EMAIL: env.GIT_EMAIL,
                    GIT_USER: env.GIT_USER_NAME,
                    GIT_REPO: env.GIT_REPO_NAME
                )
            }
        }
    }
}
